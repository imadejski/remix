#!/bin/bash

set -euo pipefail

# Evaluate models on a custom MIMIC-CXR frontal exclusive-positive subset

BASE_DIR="/opt/gpudata/imadejski/search-model/remix/data/20251006_subset_exclusive_eval_train"  # pragma: allowlist secret
EVAL_SCRIPTS_DIR="/opt/gpudata/imadejski/search-model/remix/evaluation"
# Hardcoded checkpoint groups and their model lists (mirrors your previous script)
declare -a CHECKPOINT_GROUP_DIRS=(
  "/opt/gpudata/remix/v2"
  "/opt/gpudata/remix/sent-chunk"
  "/opt/gpudata/remix/unscaled"
  "/opt/gpudata/remix/scaled"
  "/opt/gpudata/remix/no-temp"
)

declare -a CHECKPOINT_GROUP_MODELS=(
  # /opt/gpudata/remix/v2
  "mimic-biovil-frontal-impression-ig_tg-mlm-v2 mimic-biovil-frontal-impression-ig_tg-no-mlm-v2"
  # /opt/gpudata/remix/sent-chunk
  "mimic-biovil-frontal-impression-ig_tgl-mlm-v3 mimic-biovil-frontal-impression-ig_tgl-no-mlm-v3"
  # /opt/gpudata/remix/unscaled
  "mimic-biovil-frontal-impression-ig_tgl-mlm-v2 mimic-biovil-frontal-impression-ig_tgl-no-mlm-v2"
  # /opt/gpudata/remix/scaled
  "mimic-biovil-frontal-impression-ig_tgl-mlm-v2 mimic-biovil-frontal-impression-ig_tgl-no-mlm-v2"
  # /opt/gpudata/remix/no-temp
  "mimic-biovil-frontal-impression-ig_tgl-mlm-v2 mimic-biovil-frontal-impression-ig_tgl-no-mlm-v2"
)

# Path to the custom subset split CSV generated by generate_mimic_frontal_exclusive_subset.py (train only)
SUBSET_SPLIT_FILE="/opt/gpudata/imadejski/mimic-cxr/mimic_frontal_exclusive_train_5x200.csv"

# Ground-truth labels file (CheXpert auto labels per study)
LABELS_PATH="/opt/gpudata/mimic-cxr/mimic-cxr-2.0.0-chexpert.csv"

# Split name used in the subset file
SPLIT_TYPE="train"

# Labels to evaluate (comma-separated). Edit if you change the subset labels.
LABELS_LIST="Atelectasis,Cardiomegaly,Consolidation,Edema,Pleural Effusion"

# (Models are hardcoded per checkpoint group below)

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >&2; }

find_model_checkpoint() {
  local model_name="$1"
  local base_dir="$2"
  local checkpoint_path="${base_dir}/${model_name}"
  if [ -d "$checkpoint_path" ] && [ -f "$checkpoint_path/config.json" ] && [ -f "$checkpoint_path/model.safetensors" ]; then
    echo "$checkpoint_path"; return
  fi
  if [ -f "${checkpoint_path}.ckpt" ]; then echo "${checkpoint_path}.ckpt"; return; fi
  if [ -f "$checkpoint_path/last.ckpt" ]; then echo "$checkpoint_path/last.ckpt"; return; fi
  if [ -f "$checkpoint_path/checkpoints/last.ckpt" ]; then echo "$checkpoint_path/checkpoints/last.ckpt"; return; fi
  # Restrict recursive search within the provided base_dir
  local cfg_match
  cfg_match=$(find "$base_dir" -type f -name config.json -path "*/${model_name}/config.json" -print -quit 2>/dev/null || true)
  if [ -n "${cfg_match:-}" ]; then
    echo "$(dirname "$cfg_match")"; return
  fi
  local ckpt_match
  ckpt_match=$(find "$base_dir" -type f -name last.ckpt -path "*/${model_name}/last.ckpt" -print -quit 2>/dev/null || true)
  if [ -n "${ckpt_match:-}" ]; then
    echo "$ckpt_match"; return
  fi
  echo ""; return 1
}

process_model() {
  local model_name="$1"
  local checkpoints_base_dir="$2"
  local group_output_dir="$3"
  log "Processing $model_name (base: $checkpoints_base_dir)"
  local model_dir="${group_output_dir}/${model_name}"
  mkdir -p "$model_dir"
  local ckpt
  ckpt=$(find_model_checkpoint "$model_name" "$checkpoints_base_dir") || { log "Checkpoint not found for $model_name in $checkpoints_base_dir"; return 1; }
  log "Using checkpoint: $ckpt"

  # 1) Generate subset embeddings for this model (train 5x200)
  local emb_csv="${model_dir}/${model_name}_embeddings_${SPLIT_TYPE}_subset.csv"
  if [ ! -f "$emb_csv" ]; then
    log "Generating subset embeddings..."
    python "${EVAL_SCRIPTS_DIR}/general_mimic_embedding_library.py" \
      "$ckpt" \
      "$emb_csv" \
      "$SPLIT_TYPE" \
      --split_file_path "$SUBSET_SPLIT_FILE"
  else
    log "Embeddings exist for subset, skipping"
  fi

  # 2) Compute cosine similarity for the subset embeddings
  local cos_csv="${model_dir}/${model_name}_cosine_similarity_${SPLIT_TYPE}_subset.csv"
  if [ ! -f "$cos_csv" ]; then
    log "Computing cosine similarities for subset..."
    python "${EVAL_SCRIPTS_DIR}/general_mimic_cosine_similarity.py" \
      "$ckpt" \
      "$emb_csv" \
      "$cos_csv" \
      "$SPLIT_TYPE" \
      --label_type auto
  else
    log "Cosine similarities exist for subset, skipping"
  fi

  # 3) Accuracy on the subset cosine file
  local acc_csv="${model_dir}/${model_name}_accuracy_results_${SPLIT_TYPE}_subset_no_resample.csv"
  if [ ! -f "$acc_csv" ]; then
    log "Calculating accuracy metrics..."
    python "${EVAL_SCRIPTS_DIR}/general_mimic_accuracy.py" \
      --cosine-path "$cos_csv" \
      --labels-path "$LABELS_PATH" \
      --output-results-path "$acc_csv" \
      --split-type "$SPLIT_TYPE" \
      --label-type auto \
      --split-file-path "$SUBSET_SPLIT_FILE" \
      --labels "$LABELS_LIST"
  else
    log "Accuracy results exist, skipping"
  fi
}

main() {
  log "Base dir: $BASE_DIR"; mkdir -p "$BASE_DIR"; cd "$BASE_DIR"
  # Iterate hardcoded groups and their models
  for idx in "${!CHECKPOINT_GROUP_DIRS[@]}"; do
    local checkpoints_base_dir="${CHECKPOINT_GROUP_DIRS[$idx]}"
    local group_name
    group_name=$(basename "$checkpoints_base_dir")
    local group_output_dir="${BASE_DIR}/${group_name}"
    mkdir -p "$group_output_dir"
    # shellcheck disable=SC2206
    local group_models=( ${CHECKPOINT_GROUP_MODELS[$idx]} )
    log "Group $group_name: ${#group_models[@]} models"
    for m in "${group_models[@]}"; do
      process_model "$m" "$checkpoints_base_dir" "$group_output_dir" || true
    done
  done
  log "Done"
}

main "$@"
