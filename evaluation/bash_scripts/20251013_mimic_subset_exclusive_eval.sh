#!/bin/bash

set -euo pipefail

# Evaluate models on a custom MIMIC-CXR frontal exclusive-positive subset

BASE_DIR="/opt/gpudata/imadejski/search-model/remix/data/20251013_subset_exclusive_eval_train_original_loss"  # pragma: allowlist secret
EVAL_SCRIPTS_DIR="/opt/gpudata/imadejski/search-model/remix/evaluation"
MODEL_CHECKPOINTS_DIR="/opt/gpudata/remix"

# BioViL model configurations array (MIMIC-trained models)
declare -a MODELS=(
  "mimic-biovil-frontal-impression-igl_tgl-mlm"
  "mimic-biovil-frontal-impression-igl_tgl-no-mlm"
  "mimic-biovil-frontal-impression-igl_tg-mlm"
  "mimic-biovil-frontal-impression-igl_tg-no-mlm"
  "mimic-biovil-frontal-impression-ig_tgl-mlm"
  "mimic-biovil-frontal-impression-ig_tgl-no-mlm"
  "mimic-biovil-frontal-impression-ig_tg-mlm"
  "mimic-biovil-frontal-impression-ig_tg-no-mlm"
)

# Path to the custom subset split CSV generated by generate_mimic_frontal_exclusive_subset.py (train only)
SUBSET_SPLIT_FILE="/opt/gpudata/imadejski/mimic-cxr/mimic_frontal_exclusive_train_5x200.csv"

# Ground-truth labels file (CheXpert auto labels per study)
LABELS_PATH="/opt/gpudata/mimic-cxr/mimic-cxr-2.0.0-chexpert.csv"

# Split name used in the subset file
SPLIT_TYPE="train"

# Labels to evaluate (comma-separated). Edit if you change the subset labels.
LABELS_LIST="Atelectasis,Cardiomegaly,Consolidation,Edema,Pleural Effusion"

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >&2; }

find_model_checkpoint() {
  local model_name="$1"
  local checkpoint_path="${MODEL_CHECKPOINTS_DIR}/${model_name}"

  # Check if it's a directory with Hugging Face model files
  if [ -d "$checkpoint_path" ] && [ -f "$checkpoint_path/config.json" ] && [ -f "$checkpoint_path/model.safetensors" ]; then
    echo "$checkpoint_path"; return
  fi

  # Check if it's a single file (for .ckpt files)
  if [ -f "${checkpoint_path}.ckpt" ]; then echo "${checkpoint_path}.ckpt"; return; fi

  # Check alternative locations
  if [ -f "$checkpoint_path/last.ckpt" ]; then echo "$checkpoint_path/last.ckpt"; return; fi
  if [ -f "$checkpoint_path/checkpoints/last.ckpt" ]; then echo "$checkpoint_path/checkpoints/last.ckpt"; return; fi

  log "WARNING: Checkpoint not found for $model_name at $checkpoint_path"
  echo ""; return 1
}

process_model() {
  local model_name="$1"
  log "Processing model: $model_name"
  local model_dir="${BASE_DIR}/${model_name}"
  mkdir -p "$model_dir"

  # Find model checkpoint
  local ckpt
  ckpt=$(find_model_checkpoint "$model_name") || { log "Checkpoint not found for $model_name"; return 1; }
  log "Using checkpoint: $ckpt"

  # 1) Generate subset embeddings for this model (train 5x200)
  local emb_csv="${model_dir}/${model_name}_embeddings_${SPLIT_TYPE}_subset.csv"
  if [ ! -f "$emb_csv" ]; then
    log "Generating subset embeddings..."
    python "${EVAL_SCRIPTS_DIR}/general_mimic_embedding_library.py" \
      "$ckpt" \
      "$emb_csv" \
      "$SPLIT_TYPE" \
      --split_file_path "$SUBSET_SPLIT_FILE"
  else
    log "Embeddings exist for subset, skipping"
  fi

  # 2) Compute cosine similarity for the subset embeddings
  local cos_csv="${model_dir}/${model_name}_cosine_similarity_${SPLIT_TYPE}_subset.csv"
  if [ ! -f "$cos_csv" ]; then
    log "Computing cosine similarities for subset..."
    python "${EVAL_SCRIPTS_DIR}/general_mimic_cosine_similarity.py" \
      "$ckpt" \
      "$emb_csv" \
      "$cos_csv" \
      "$SPLIT_TYPE" \
      --label_type auto
  else
    log "Cosine similarities exist for subset, skipping"
  fi

  # 3) Accuracy on the subset cosine file
  local acc_csv="${model_dir}/${model_name}_accuracy_results_${SPLIT_TYPE}_subset_no_resample.csv"
  if [ ! -f "$acc_csv" ]; then
    log "Calculating accuracy metrics..."
    python "${EVAL_SCRIPTS_DIR}/general_mimic_accuracy.py" \
      --cosine-path "$cos_csv" \
      --labels-path "$LABELS_PATH" \
      --output-results-path "$acc_csv" \
      --split-type "$SPLIT_TYPE" \
      --label-type auto \
      --split-file-path "$SUBSET_SPLIT_FILE" \
      --labels "$LABELS_LIST"
  else
    log "Accuracy results exist, skipping"
  fi
}

main() {
  log "Starting evaluation process..."
  log "Base directory: $BASE_DIR"
  log "Model checkpoints directory: $MODEL_CHECKPOINTS_DIR"
  log "Total models to process: ${#MODELS[@]}"

  mkdir -p "$BASE_DIR"
  cd "$BASE_DIR"

  # Track results
  local successful_models=()
  local failed_models=()

  # Process each model
  for model in "${MODELS[@]}"; do
    log "=================================================="
    if process_model "$model"; then
      successful_models+=("$model")
    else
      failed_models+=("$model")
    fi
    log "--------------------"
  done

  # Summary
  log "=================================================="
  log "EVALUATION SUMMARY"
  log "=================================================="
  log "Successfully processed models (${#successful_models[@]}):"
  for model in "${successful_models[@]}"; do
    log "  ✓ $model"
  done

  if [ ${#failed_models[@]} -gt 0 ]; then
    log ""
    log "Failed models (${#failed_models[@]}):"
    for model in "${failed_models[@]}"; do
      log "  ✗ $model"
    done
  fi

  log ""
  log "Evaluation process completed!"
  log "Results are stored in individual model folders under: $BASE_DIR"
}

main "$@"
